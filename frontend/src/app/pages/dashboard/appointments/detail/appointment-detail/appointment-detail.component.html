<div class="appointment-detail px-3 py-4">
  <div class="mb-3">
    <button class="btn btn-outline-secondary btn-sm" (click)="goBack()">← Volver</button>
  </div>

  <div *ngIf="loading" class="alert alert-info">Cargando cita…</div>
  <div *ngIf="error && !loading" class="alert alert-danger">{{ error }}</div>

  <div *ngIf="appointment && !loading">
    <!-- Encabezado -->
    <h1 class="appointment-title">Cita #{{ appointment.id }}</h1>
    <div class="appointment-date">
      {{ appointment.start_time | date:'fullDate' }} · {{ appointment.start_time | date:'shortTime' }}
    </div>

    <!-- Información del paciente -->
    <div class="card-section mt-3">
      <h4 class="section-title">Información del paciente</h4>
      <div class="info-grid">
        <div class="card-item">
          <span class="field-label">Nombre</span>
          <div>{{ appointment.patient.first_name }} {{ appointment.patient.last_name }}</div>
        </div>
        <div class="card-item">
          <span class="field-label">Sexo</span>
          <span class="badge" [ngClass]="{
                  'bg-primary text-light': appointment.patient.gender === 'MASCULINO',
                  'bg-pink text-light': appointment.patient.gender === 'FEMENINO'
                }">
            {{ appointment.patient.gender || '—' }}
          </span>
        </div>
        <div class="card-item">
          <span class="field-label">Email</span>
          <div>{{ appointment.patient.email || '—' }}</div>
        </div>
        <div class="card-item">
          <span class="field-label">Teléfono</span>
          <div>{{ appointment.patient.phone || '—' }}</div>
        </div>
        <div class="card-item">
          <span class="field-label">Fecha de nacimiento</span>
          <div>{{ appointment.patient.birth_date | date:'longDate' }}</div>
        </div>
        <div class="card-item">
          <span class="field-label">Tipo de sangre</span>
          <span class="badge bg-danger text-light px-3 py-1">
            {{ appointment.patient.blood_type || '—' }}
          </span>
        </div>
      </div>
    </div>

    <!-- Detalles de la cita -->
    <div class="card-section mt-4">
      <h4 class="section-title">Detalles de la cita</h4>
      <div class="info-grid">
        <div class="card-item">
          <span class="field-label">Fecha de inicio</span>
          <div>{{ appointment.start_time | date:'fullDate' }} · {{ appointment.start_time | date:'hh:mm a' }}</div>
        </div>
        <div class="card-item">
          <span class="field-label">Fecha de fin</span>
          <div>{{ appointment.end_time | date:'fullDate' }} · {{ appointment.end_time | date:'hh:mm a' }}</div>
        </div>
        <div class="card-item full-width">
          <span class="field-label">Motivo</span>
          <div>{{ appointment.reason || '—' }}</div>
        </div>
      </div>
    </div>

    <!-- Detalles de la prescripcion -->
    <div class="card-section mt-4" *ngIf="appointment && !loading">
      <h4 class="section-title">Prescripción</h4>

      <div *ngIf="appointment.prescription; else noPrescription">
        <p><strong>Medicamentos:</strong> {{ appointment.prescription.medication_details }}</p>
        <p><strong>Instrucciones:</strong> {{ appointment.prescription.instructions }}</p>
        <p><strong>Precauciones:</strong> {{ appointment.prescription.precautions }}</p>
        <div class="d-flex justify-content-end gap-2">
          <button class="btn btn-primary btn-sm" (click)="openPrescriptionForm()">Editar Prescripción</button>
          <button class="btn btn-danger btn-sm" (click)="onDelete()">Eliminar Prescripción</button>
        </div>
      </div>

      <ng-template #noPrescription>
        <p>No hay prescripción registrada para esta cita.</p>
        <button class="btn btn-primary btn-sm" (click)="openPrescriptionForm()">Agregar Prescripción</button>
      </ng-template>

      <!-- Formulario para crear/editar prescripción -->
      <div *ngIf="showPrescriptionForm" class="mt-3 p-3 border rounded">
        <app-prescription-form [initialData]="editingPrescription" (submitForm)="savePrescription($event)"
          (cancel)="closePrescriptionForm()">
        </app-prescription-form>
      </div>
    </div>
  </div>
</div>